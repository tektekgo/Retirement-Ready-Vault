# Supabase Keepalive - GitHub Actions
# Runs every 4 days to prevent project deactivation
# This runs on GitHub's servers, independent of your local machine

name: Supabase Keepalive

on:
  schedule:
    # Run every 4 days at 2:00 AM UTC
    - cron: '0 2 */4 * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  keepalive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Supabase Keepalive - Production
      env:
        SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
      run: |
        echo "=== Supabase Keepalive Started ==="
        echo "Date: $(date)"
        echo "Environment: Production"
        echo "Supabase URL: $SUPABASE_URL"
        
        # Create keepalive script
        cat > keepalive.cjs << 'EOF'
        const https = require('https');
        const http = require('http');
        
        const SUPABASE_URL = process.env.SUPABASE_URL;
        const SUPABASE_KEY = process.env.SUPABASE_ANON_KEY;
        
        const headers = {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json'
        };
        
        async function makeRequest(url) {
          return new Promise((resolve, reject) => {
            const urlObj = new URL(url);
            const options = {
              hostname: urlObj.hostname,
              port: urlObj.port || (urlObj.protocol === 'https:' ? 443 : 80),
              path: urlObj.pathname + urlObj.search,
              method: 'GET',
              headers: headers
            };
            
            const req = (urlObj.protocol === 'https:' ? https : http).request(options, (res) => {
              let data = '';
              res.on('data', chunk => data += chunk);
              res.on('end', () => {
                try {
                  const jsonData = JSON.parse(data);
                  resolve({ status: res.statusCode, data: jsonData });
                } catch (e) {
                  resolve({ status: res.statusCode, data: data });
                }
              });
            });
            
            req.on('error', reject);
            req.setTimeout(30000, () => reject(new Error('Request timeout')));
            req.end();
          });
        }
        
        async function performKeepalive() {
          const timestamp = new Date().toISOString();
          console.log(`[${timestamp}] Starting comprehensive keepalive...`);
          
          const operations = [
            { url: `${SUPABASE_URL}/rest/v1/user_profiles?select=id,email&limit=5`, name: 'Query user profiles' },
            { url: `${SUPABASE_URL}/rest/v1/retirement_data?select=id,user_id&limit=5`, name: 'Query retirement data' },
            { url: `${SUPABASE_URL}/rest/v1/api_usage_logs?select=id,api_provider&limit=3`, name: 'Query API usage logs' },
          ];
          
          let successCount = 0;
          let totalOperations = operations.length;
          
          for (const op of operations) {
            try {
              console.log(`[${timestamp}] Executing: ${op.name}`);
              const result = await makeRequest(op.url);
              
              if (result.status === 200) {
                console.log(`[${timestamp}] ✅ ${op.name} - Success (${Array.isArray(result.data) ? result.data.length : 'OK'} records)`);
                successCount++;
              } else {
                console.log(`[${timestamp}] ⚠️ ${op.name} - Status ${result.status}`);
              }
            } catch (error) {
              console.log(`[${timestamp}] ❌ ${op.name} - Error: ${error.message}`);
            }
          }
          
          const successRate = Math.round((successCount / totalOperations) * 100);
          console.log(`[${timestamp}] === Keepalive Summary ===`);
          console.log(`[${timestamp}] Operations: ${successCount}/${totalOperations} successful (${successRate}%)`);
          
          if (successCount > 0) {
            console.log(`[${timestamp}] ✅ KEEPALIVE SUCCESS - Project is active and healthy`);
            return { success: true, message: `Keepalive completed successfully - ${successCount}/${totalOperations} operations successful` };
          } else {
            console.log(`[${timestamp}] ❌ KEEPALIVE FAILURE - All operations failed`);
            return { success: false, message: 'Keepalive failed - all operations failed' };
          }
        }
        
        performKeepalive()
          .then(result => {
            console.log(`[${new Date().toISOString()}] Final result:`, result);
            process.exit(result.success ? 0 : 1);
          })
          .catch(error => {
            console.error(`[${new Date().toISOString()}] Fatal error:`, error);
            process.exit(1);
          });
        EOF
        
        # Run the keepalive script
        node keepalive.cjs
        
    - name: Send Success Notification
      if: success()
      env:
        RESEND_API_KEY: ${{ secrets.VITE_RESEND_API_KEY }}
        NOTIFICATION_EMAIL: ${{ secrets.VITE_ADMIN_EMAIL }}
      run: |
        echo "=== Sending Success Notification via Resend ==="
        
        # Create email payload for Resend
        cat > email-success.json << EOF
        {
          "from": "Retirement Ready Vault <noreply@mail.ai-focus.org>",
          "to": ["$NOTIFICATION_EMAIL"],
          "subject": "✅ Supabase Keepalive SUCCESS - $(date -u '+%Y-%m-%d %H:%M:%S UTC')",
          "html": "<h2>Supabase Keepalive Success</h2><p><strong>Status:</strong> ✅ SUCCESS</p><p><strong>Time:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p><p><strong>Project:</strong> Retirement Ready Vault</p><p><strong>Supabase URL:</strong> https://cqwuursyoonmbczzqtnl.supabase.co</p><p><strong>Message:</strong> Keepalive completed successfully - Project is active and healthy</p><h3>What this means:</h3><ul><li>✅ Your Supabase project is active</li><li>✅ Database operations completed successfully</li><li>✅ No action required</li><li>✅ Project protected from deactivation</li></ul><p><em>This is an automated notification from your Supabase Keepalive system.</em></p>"
        }
        EOF
        
        # Send email via Resend API
        curl -X POST "https://api.resend.com/emails" \
          -H "Authorization: Bearer $RESEND_API_KEY" \
          -H "Content-Type: application/json" \
          -d @email-success.json
        
        echo "Success notification sent via Resend"
        
    - name: Send Failure Notification
      if: failure()
      env:
        RESEND_API_KEY: ${{ secrets.VITE_RESEND_API_KEY }}
        NOTIFICATION_EMAIL: ${{ secrets.VITE_ADMIN_EMAIL }}
      run: |
        echo "=== Sending Failure Notification via Resend ==="
        
        # Create email payload for Resend
        cat > email-failure.json << EOF
        {
          "from": "Retirement Ready Vault <noreply@mail.ai-focus.org>",
          "to": ["$NOTIFICATION_EMAIL"],
          "subject": "❌ Supabase Keepalive FAILURE - $(date -u '+%Y-%m-%d %H:%M:%S UTC')",
          "html": "<h2>Supabase Keepalive Failure</h2><p><strong>Status:</strong> ❌ FAILURE</p><p><strong>Time:</strong> $(date -u '+%Y-%m-%d %H:%M:%S UTC')</p><p><strong>Project:</strong> Retirement Ready Vault</p><p><strong>Supabase URL:</strong> https://cqwuursyoonmbczzqtnl.supabase.co</p><p><strong>Message:</strong> Keepalive failed - manual intervention may be required</p><h3>Immediate Actions Required:</h3><ul><li>❌ Check Supabase dashboard for project status</li><li>❌ Verify API keys and connectivity</li><li>❌ Review GitHub Actions logs for error details</li><li>❌ Consider manual intervention</li></ul><h3>Troubleshooting Steps:</h3><ol><li>Go to GitHub Actions dashboard</li><li>Check the failed workflow run</li><li>Review detailed logs</li><li>Verify Supabase project is active</li><li>Test API keys manually if needed</li></ol><p><em>This is an automated notification from your Supabase Keepalive system.</em></p>"
        }
        EOF
        
        # Send email via Resend API
        curl -X POST "https://api.resend.com/emails" \
          -H "Authorization: Bearer $RESEND_API_KEY" \
          -H "Content-Type: application/json" \
          -d @email-failure.json
        
        echo "Failure notification sent via Resend"
